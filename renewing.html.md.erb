---
title: Renewing Expired Certificates for IPsec for VMware Tanzu
owner: Security Engineering
---

<strong><%= modified_date %></strong>

This topic describes the basic process that you can use to renew any already expired certificates contained in
the <%= vars.product_full %> manifest.

## <a id="about-expiration"></a>About Certificate Expiration

<%= vars.product_short %> relies upon X.509 certificates to secure the communications between communicating peers.

Like all certificates, <%= vars.product_short %> certificates have a finite lifetime and eventually expire.  The certificates generated by the
procedure provided in the installation instructions, [Generate a Self-Signed Certificate](./installing.html#self-signed)
have a default lifetime of one year.  Regardless of their specific lifetime, all certificates must eventually be rotated, and so
it is important for the operations team to plan accordingly and remember to rotate <%= vars.product_short %> certificates before they actually expire.

<p class="note"><span class="note__title">Note</span> Rotating the certificates while they are still valid
   ensures the maximum availability of the Cloud Foundry platform and avoids any unscheduled interruption in service.</p>

## <a id="renew-certs"></a>Renew Expired <%= vars.product_short %> Certificates

To renew expired <%= vars.product_short %> certificates, do the following:

1. Retrieve the latest runtime config by running the following command:

    ```
    bosh -e BOSH-ENVIRONMENT runtime-config > PATH-TO-SAVE-THE-RUNTIME-CONFIG
    ```
1. Generate a new set of certificates.
   For development or test environments, you can use self-signed certificates.
   For information about self-signed certificates, see [Generate a Self-Signed Certificate](./installing.html#self-signed).

1. In the runtime `config.yml` file saved from step 1, update the `optional` field to `true` and update the certificate fields with new certificates.
   For more information about these fields,
   see the field descriptions under [Create the <%= vars.product_short %> Manifest](./installing.html#create-mfest).

    ```
    properties:
      ipsec:
        <strong>optional</strong>: true
        <strong>instance\_certificate</strong>: |
          -----BEGIN CERTIFICATE-----
          EXAMPLEAhigAwIBAgIRAIvrBY2TttU/LeRhO+V1t0YwDQYJKoZIhvcNAQELBQAw
          ...
          -----END CERTIFICATE-----
        <strong>instance\_private\_key</strong>: |
          -----BEGIN EXAMPLE RSA PRIVATE KEY-----
          EXAMPLExRSAxPRIVATExKEYxDATAxEXAMPLExRSAxPRIVATExKEYxDATA
          ...
          -----END EXAMPLE RSA PRIVATE KEY-----
        <strong>ca\_certificates</strong>:
          \- |
            -----BEGIN CERTIFICATE-----
            EXAMPLEAvGgAwIBAgIBATANBgkqhkiG9w0BAQsFADAUMRIwEAYDVQQDEwl0ZXN0
            ...
            -----END CERTIFICATE-----
    ```

1. Update the runtime config by running the following command:

    ```
    bosh -e BOSH-ENVIRONMENT update-runtime-config --name=ipsec PATH-TO-SAVE-THE-RUNTIME-CONFIG
    ```

1. Go to your **Installation Dashboard** in <%= vars.ops_manager %>.
1. If you are using <%= vars.ops_manager %> v2.3 or later, click **Review Pending Changes**.
   For more information about this <%= vars.ops_manager %> page,
   see [Reviewing your pending product changes in Tanzu Operations Manager](https://docs.vmware.com/en/VMware-Tanzu-Operations-Manager/3.0/vmware-tanzu-ops-manager/install-review-pending-changes.html).
1. Click **Apply Changes**.
1. Set the `optional` field in the `config.yml` back to `false`.
1. Repeat steps 4 through 6 to update the runtime config again.
1. Click **Apply Changes**.

##<a id="ha-scenario"></a>High-Availability (HA) Clusters

The IPsec add-on includes a setting named policy_optional that determines whether using IPsec for communication between the specified IP CIDRs is optional.
If policy_optional is set to false, it is mandatory that communication be through IPsec among the specified IP CIDRs in the IPsec manifest.
This can present a unique scenario while rotating the expired IPsec certificates for HA clusters, such as Tanzu Application Service's
deployment MySQL cluster. To work around this, we can temporarily make IPsec optional through the BOSH CLI and then rotate the certificates.

 The workaround includes:

1. BOSH SSH into instance
2. monit stop ipsec
3. Update IPsec file to make policy_optional to true in the IPsec config file strongswan.conf
4. Run IPsec lifecycle scripts
5. Start IPsec once

This logic can be scripted.

Please reference the following command for an example of how to make IPsec optional temporarily to reestablish communication between impacted VMs in a Tanzu Application Service deployment with deployment name "cf-1631c63accc0c5ca075c".

Be sure to make any necessary adjustments to how BOSH CLI is used.

  ```
  bosh -d INSERT_YOUR_DEPLOYMENT_NAME ssh -c "
  sudo monit stop ipsec
  sudo sed -i 's/policy_optional = no/policy_optional = yes/g' /var/vcap/jobs/ipsec/etc/strongswan.conf
  sudo /var/vcap/jobs/ipsec/bin/post-stop
  sudo /var/vcap/jobs/ipsec/bin/pre-start
  sleep 10
  sudo monit start ipsec"
  ```

After communication is reestablished, rotation of the IPsec certificates can take place. After this you must reverse the above change to set policy_optional to 'no'.
